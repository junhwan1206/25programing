<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auto-Subtitle Demo | HTML/CSS Only Frontend</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111a2e;
      --muted: #1a2440;
      --text: #e6eefc;
      --subtext: #a6b3d0;
      --brand: #6aa2ff;
      --accent: #7cf2d3;
      --danger: #ff6a7a;
      --warn: #ffc861;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    * { box-sizing: border-box; }
    html,body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #0b1220 0%, #0c1528 100%);
      color: var(--text);
    }
    a { color: var(--brand); text-decoration: none; }
    header {
      position: sticky; top: 0; z-index: 20;
      backdrop-filter: saturate(160%) blur(6px);
      background: rgba(10,16,30,.6);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .nav {
      max-width: 1200px; margin: 0 auto; padding: 14px 20px;
      display: flex; align-items: center; gap: 16px; justify-content: space-between;
    }
    .brand { display: flex; gap: 10px; align-items: center; font-weight: 700; letter-spacing: .3px; }
    .brand .logo { width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, var(--brand), var(--accent)); box-shadow: inset 0 0 0 2px rgba(255,255,255,.15); }
    .pill {
      display: inline-flex; gap: 8px; align-items: center;
      background: var(--muted); color: var(--text); padding: 8px 12px;
      border-radius: 999px; border: 1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow);
    }
    .btn {
      appearance: none; border: none; cursor: pointer;
      background: linear-gradient(180deg, #274a96 0%, #1d376d 100%);
      color: white; padding: 10px 14px; border-radius: 10px; font-weight: 700;
      border: 1px solid rgba(255,255,255,.08);
      transition: transform .06s ease, filter .2s ease;
    }
    .btn:hover { filter: brightness(1.08); }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { background: #1a2440; color: var(--text); }
    .btn.ghost { background: transparent; border: 1px dashed rgba(255,255,255,.18); color: var(--subtext); }
    .btn.warn { background: #3c2b06; color: #ffd37c; border-color: #6b520f; }
    .btn.danger { background: #3a0f17; color: #ff9aa7; border-color: #5e1d2a; }

    .wrap { max-width: 1200px; margin: 24px auto; padding: 0 20px 40px; }
    .grid { display: grid; grid-template-columns: 1.2fr .8fr; gap: 18px; }
    @media (max-width: 980px){ .grid { grid-template-columns: 1fr; } }

    .card {
      background: radial-gradient(1200px 1200px at 0% -10%, rgba(106,162,255,.08), transparent 40%),
                  linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card .hd { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,.06); display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .title { font-weight: 800; letter-spacing: .2px; }
    .sub { color: var(--subtext); font-size: .9rem; }
    .card .bd { padding: 16px; }

    .stack { display: grid; gap: 12px; }

    .video-wrap { position: relative; border-radius: 12px; overflow: hidden; background: #050914; border: 1px solid rgba(255,255,255,.06); }
    video { width: 100%; display: block; background: #000; max-height: 420px; }

    .form-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    .field { display: grid; gap: 6px; }
    label { color: var(--subtext); font-size: .9rem; }
    input[type="text"], input[type="number"], textarea, select {
      width: 100%; background: #0d1529; color: var(--text);
      border: 1px solid rgba(255,255,255,.1); padding: 10px 12px; border-radius: 10px;
    }

    /* Caption table */
    table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
    thead th { text-align: left; font-size: .85rem; color: var(--subtext); font-weight: 700; }
    tbody tr { background: #0d1529; border: 1px solid rgba(255,255,255,.08); }
    tbody td { padding: 10px; vertical-align: top; }
    tbody tr { border-radius: 10px; }
    tbody tr td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
    tbody tr td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }

    .time-box { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .cap-text { width: 100%; min-height: 44px; resize: vertical; }

    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }

    /* Library */
    .lib-item { padding: 12px; border: 1px solid rgba(255,255,255,.08); border-radius: 12px; background: #0d1529; display: grid; gap: 8px; }
    .lib-meta { display: flex; gap: 10px; align-items: center; color: var(--subtext); font-size: .9rem; }
    .dot { width: 8px; height: 8px; border-radius: 999px; background: var(--accent); display: inline-block; }

    .empty { color: var(--subtext); text-align: center; padding: 16px; border: 1px dashed rgba(255,255,255,.14); border-radius: 12px; }
    .hint { color: var(--subtext); font-size: .92rem; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #0d1322; border: 1px solid rgba(255,255,255,.12); padding: 2px 6px; border-radius: 6px; }
    .right { text-align: right; }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <div>Auto‑Subtitle <span class="sub" style="font-weight:600;">(프론트엔드 데모)</span></div>
      </div>
      <div class="pill">
        <span class="sub">이 페이지는</span>
        <strong>HTML/CSS(+약간의 JS)</strong>
        <span class="sub">로 동작하는 프로토타입입니다.</span>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- Left: Video + Editor -->
      <section class="card">
        <div class="hd">
          <div class="title">1) 업로드 & 미리보기</div>
          <div class="toolbar">
            <label class="btn ghost" for="videoFile">동영상 선택</label>
            <input id="videoFile" type="file" accept="video/*" style="display:none">
            <button class="btn secondary" id="btnDemoAuto">자동 자막 생성 (데모)</button>
          </div>
        </div>
        <div class="bd stack">
          <div class="video-wrap">
            <video id="player" controls crossorigin="anonymous"></video>
          </div>
          <div class="hint">※ 실제 자동 자막은 서버/모델(예: Whisper)과 연동이 필요합니다. 여기서는 편집/적용/다운로드 UI를 제공해요.</div>
        </div>
      </section>

      <!-- Right: Library -->
      <aside class="card">
        <div class="hd">
          <div class="title">라이브러리</div>
          <div class="sub">자막을 적용해 저장하면 여기에 목록이 쌓여요</div>
        </div>
        <div class="bd">
          <div id="library" class="stack">
            <div class="empty">아직 저장된 항목이 없어요.</div>
          </div>
        </div>
      </aside>
    </div>

    <section class="card" style="margin-top:18px;">
      <div class="hd">
        <div>
          <div class="title">2) 자막 편집기</div>
          <div class="sub">행 추가/삭제, 시간과 내용을 수정하고, 바로 동영상에 적용할 수 있어요.</div>
        </div>
        <div class="toolbar">
          <button class="btn" id="btnAdd">행 추가</button>
          <button class="btn warn" id="btnClear">전체 지우기</button>
          <button class="btn" id="btnApply">자막 적용</button>
          <button class="btn secondary" id="btnDownloadVTT">VTT 다운로드</button>
          <button class="btn secondary" id="btnDownloadSRT">SRT 다운로드</button>
          <button class="btn" id="btnSaveLib">라이브러리에 저장</button>
        </div>
      </div>
      <div class="bd">
        <div class="stack">
          <table>
            <thead>
              <tr>
                <th style="width:110px;">시작 (s)</th>
                <th style="width:110px;">종료 (s)</th>
                <th>자막 내용</th>
                <th style="width:120px;">작업</th>
              </tr>
            </thead>
            <tbody id="capBody"></tbody>
          </table>
          <div class="hint">팁: 동영상에서 중요한 타이밍에 <span class="kbd">스페이스</span>로 일시정지 → 현재 시간을 시/종료칸에 넣어 빠르게 편집하세요.</div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:18px;">
      <div class="hd">
        <div class="title">3) 사용 가이드</div>
      </div>
      <div class="bd">
        <ol class="stack" style="margin:0; padding-left:18px;">
          <li>상단에서 동영상을 선택하면 미리보기가 열립니다.</li>
          <li>자막 편집기에서 <b>행 추가</b> → 시작/종료 시간을 초 단위로 입력 → 내용을 적습니다.</li>
          <li><b>자막 적용</b>을 누르면 즉시 동영상에 WebVTT 트랙으로 붙습니다.</li>
          <li>완성된 자막은 <b>VTT/SRT</b>로 다운로드 가능하며, <b>라이브러리에 저장</b>하면 브라우저(LocalStorage)에 목록이 쌓입니다.</li>
          <li>오른쪽 <b>라이브러리</b>에서 클릭하면 저장한 영상과 자막을 다시 불러옵니다(동영상은 같은 파일명을 재선택해야 완전 일치합니다).</li>
        </ol>
      </div>
    </section>
  </div>

  <script>
    // --- State ---
    const player = document.getElementById('player');
    const capBody = document.getElementById('capBody');
    let trackEl = null; // <track> element for preview
    let currentVideoName = null; // file name hint for library keying

    // --- Utils ---
    const pad = (n, l=2) => String(n).padStart(l, '0');
    function sToTimestamp(t){
      // returns WebVTT timestamp (hh:mm:ss.mmm)
      const s = Math.max(0, Number(t)||0);
      const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = Math.floor(s%60);
      const ms = Math.round((s - Math.floor(s)) * 1000);
      return `${pad(h)}:${pad(m)}:${pad(sec)}.${pad(ms,3)}`;
    }
    function sToSrtTimestamp(t){
      const s = Math.max(0, Number(t)||0);
      const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = Math.floor(s%60);
      const ms = Math.round((s - Math.floor(s)) * 1000);
      return `${pad(h)}:${pad(m)}:${pad(sec)},${pad(ms,3)}`;
    }
    function downloadText(filename, text){
      const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    // --- Caption Rows CRUD ---
    function addRow(st=0, et=2, txt=''){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="number" step="0.01" value="${Number(st)}" class="cap-start"></td>
        <td><input type="number" step="0.01" value="${Number(et)}" class="cap-end"></td>
        <td><textarea class="cap-text" placeholder="자막 내용을 입력하세요">${txt}</textarea></td>
        <td class="right">
          <button class="btn secondary btnSetStart">시작=현재</button>
          <button class="btn secondary btnSetEnd">종료=현재</button>
          <button class="btn danger btnDel">삭제</button>
        </td>`;
      capBody.appendChild(tr);
    }
    function clearRows(){ capBody.innerHTML = ''; }
    function getCaptions(){
      const rows = [...capBody.querySelectorAll('tr')];
      return rows.map(r => ({
        start: Number(r.querySelector('.cap-start').value)||0,
        end: Number(r.querySelector('.cap-end').value)||0,
        text: r.querySelector('.cap-text').value.trim()
      })).filter(x => x.text);
    }

    // --- Build VTT/SRT ---
    function buildVTT(caps){
      const lines = ['WEBVTT',''];
      caps.forEach(c => {
        lines.push(`${sToTimestamp(c.start)} --> ${sToTimestamp(c.end)}`);
        lines.push(c.text);
        lines.push('');
      });
      return lines.join('\n');
    }
    function buildSRT(caps){
      const lines = [];
      caps.forEach((c,i) => {
        lines.push(String(i+1));
        lines.push(`${sToSrtTimestamp(c.start)} --> ${sToSrtTimestamp(c.end)}`);
        lines.push(c.text);
        lines.push('');
      });
      return lines.join('\n');
    }

    // --- Apply to <video> ---
    function applyCaptions(){
      const caps = getCaptions().sort((a,b)=>a.start-b.start);
      if(!caps.length){ alert('자막 행이 없습니다. 먼저 추가/입력해주세요.'); return; }
      const vtt = buildVTT(caps);
      const blob = new Blob([vtt], {type:'text/vtt'});
      const url = URL.createObjectURL(blob);
      if(trackEl){ trackEl.remove(); trackEl = null; }
      trackEl = document.createElement('track');
      trackEl.kind = 'subtitles'; trackEl.label = 'Korean'; trackEl.srclang = 'ko'; trackEl.default = true; trackEl.src = url;
      player.appendChild(trackEl);
      // Force reload of tracks
      player.textTracks && [...player.textTracks].forEach(tt => tt.mode = 'showing');
    }

    // --- Library (LocalStorage) ---
    const LIB_KEY = 'auto_subtitle_library_v1';
    function loadLib(){ try { return JSON.parse(localStorage.getItem(LIB_KEY)||'[]'); } catch { return []; } }
    function saveLib(arr){ localStorage.setItem(LIB_KEY, JSON.stringify(arr)); }
    function refreshLibUI(){
      const lib = loadLib();
      const box = document.getElementById('library');
      box.innerHTML = '';
      if(!lib.length){
        const d = document.createElement('div'); d.className='empty'; d.textContent='아직 저장된 항목이 없어요.'; box.appendChild(d); return;
      }
      lib.forEach((item, idx) => {
        const el = document.createElement('div'); el.className='lib-item';
        el.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
            <div style="font-weight:800;">${item.title||item.filename||'무제'}</div>
            <div class="lib-meta"><span class="dot"></span> ${new Date(item.savedAt).toLocaleString()}</div>
          </div>
          <div class="sub">파일명 힌트: <span class="kbd">${item.filename||'-'}</span></div>
          <div class="toolbar" style="justify-content:flex-end;">
            <button class="btn secondary" data-idx="${idx}" data-act="load">불러오기</button>
            <button class="btn danger" data-idx="${idx}" data-act="del">삭제</button>
          </div>`;
        box.appendChild(el);
      });
    }

    function saveCurrentToLib(){
      const caps = getCaptions();
      if(!caps.length){ alert('저장할 자막이 없습니다.'); return; }
      const title = prompt('라이브러리 제목(선택):', currentVideoName || '무제 영상');
      const lib = loadLib();
      lib.unshift({ title, filename: currentVideoName, captions: caps, savedAt: Date.now() });
      saveLib(lib); refreshLibUI();
    }

    function loadItemToEditor(item){
      clearRows();
      (item.captions||[]).forEach(c => addRow(c.start, c.end, c.text));
      if(player && currentVideoName && item.filename && currentVideoName === item.filename){
        applyCaptions();
      } else {
        alert('동영상 파일명이 다를 수 있어요. 같은 파일을 선택한 뒤 자막을 적용하세요.');
      }
    }

    // --- Event Handlers ---
    document.getElementById('videoFile').addEventListener('change', e => {
      const file = e.target.files[0];
      if(!file) return;
      currentVideoName = file.name;
      const url = URL.createObjectURL(file);
      player.src = url;
      if(trackEl){ trackEl.remove(); trackEl = null; }
    });

    document.getElementById('btnAdd').addEventListener('click', () => {
      const t = player.currentTime || 0;
      addRow(Math.max(0, t-0.2), t+2, '');
    });
    document.getElementById('btnClear').addEventListener('click', () => {
      if(confirm('자막 행을 모두 삭제할까요?')) clearRows();
    });
    document.getElementById('btnApply').addEventListener('click', applyCaptions);

    document.getElementById('btnDownloadVTT').addEventListener('click', () => {
      const caps = getCaptions().sort((a,b)=>a.start-b.start);
      if(!caps.length) return alert('먼저 자막을 입력하세요.');
      const vtt = buildVTT(caps);
      downloadText((currentVideoName||'captions') + '.vtt', vtt);
    });
    document.getElementById('btnDownloadSRT').addEventListener('click', () => {
      const caps = getCaptions().sort((a,b)=>a.start-b.start);
      if(!caps.length) return alert('먼저 자막을 입력하세요.');
      const srt = buildSRT(caps);
      downloadText((currentVideoName||'captions') + '.srt', srt);
    });
    document.getElementById('btnSaveLib').addEventListener('click', saveCurrentToLib);

    document.getElementById('library').addEventListener('click', e => {
      const b = e.target.closest('button'); if(!b) return;
      const idx = Number(b.dataset.idx); const act = b.dataset.act; if(Number.isNaN(idx)) return;
      const lib = loadLib();
      if(act==='del'){
        if(confirm('이 항목을 삭제할까요?')){ lib.splice(idx,1); saveLib(lib); refreshLibUI(); }
      } else if(act==='load'){
        loadItemToEditor(lib[idx]);
      }
    });

    // Row buttons
    capBody.addEventListener('click', e => {
      const tr = e.target.closest('tr'); if(!tr) return;
      if(e.target.classList.contains('btnDel')){
        tr.remove();
      } else if(e.target.classList.contains('btnSetStart')){
        tr.querySelector('.cap-start').value = (player.currentTime||0).toFixed(2);
      } else if(e.target.classList.contains('btnSetEnd')){
        tr.querySelector('.cap-end').value = (player.currentTime||0).toFixed(2);
      }
    });

    // Space toggles play/pause when video focused
    document.addEventListener('keydown', e => {
      if(e.code === 'Space' && document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'INPUT'){
        e.preventDefault();
        if(player.paused) player.play(); else player.pause();
      }
    });

    // Demo auto caption generation (mock)
    document.getElementById('btnDemoAuto').addEventListener('click', () => {
      if(!player.duration || player.duration === Infinity){
        alert('먼저 동영상을 선택해 주세요.'); return;
      }
      clearRows();
      const dur = Math.floor(player.duration);
      const step = Math.max(2, Math.floor(dur/8));
      let s = 0, i = 1;
      while(s < dur){
        const e = Math.min(dur, s + step);
        addRow(s, e, `자동 생성 자막 예시 ${i}`);
        s = e; i++;
      }
      applyCaptions();
    });

    // init
    refreshLibUI();
  </script>
</body>
</html>
